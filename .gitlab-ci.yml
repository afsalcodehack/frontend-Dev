stages:
  - test
  - build
  - verify

image: jayvdb/ionic:xenial

variables:
  XDG_CACHE_HOME: "$CI_PROJECT_DIR/.cache/"
  GRADLE_OPTS: -Dorg.gradle.daemon=false
  ANDROID_ARTIFACT_DIR: $CI_PROJECT_DIR/platforms/android/app/build/outputs/apk

cache:
  key: node-pnpm
  paths: &node_lock_cache_paths
    - .pnpm-store

.npm_init: &npm_init |
  export PATH=$CI_PROJECT_DIR/.ci/bin:$PATH
  npm set optional false
  npm set production true
  npm set dev true
  rm -rf node_modules
  npm set store $CI_PROJECT_DIR/.pnpm-store
  npm set pnpmfile $CI_PROJECT_DIR/pnpmfile.js
  npm set prefer-frozen-shrinkwrap true
  npm set prefer-offline true
  [ -n "$(which pnpm 2>/dev/null)" ] || npm install -g pnpm
  ln -s $(which pnpm) .ci/bin/npm
  ln -s $(which pnpx) .ci/bin/npx

before_script:
  - *npm_init
  - pnpm install --no-save
  - change-environment "$CI_COMMIT_REF_NAME"

.collect_artifacts: &collect_artifacts
  artifacts:
    name: "$CI_JOB_NAME-$CI_COMMIT_REF_SLUG"
    paths:
      - www
      - www-dev-offline
      - $ANDROID_ARTIFACT_DIR

test:lint:
  image: okdocker/pynode:3.6-10.x
  stage: test
  cache:
    key: coala-pnpm
    paths:
      - .cache/pip
      - .pnpm-store
  before_script:
    - *npm_init
    - npm config set package-import-method copy
    - pnpm install -g csscomb sass-lint
  script: test_lint

test:tslint:
  stage: test
  image: node:8
  cache:
    key: tslint-pnpm
    paths: *node_lock_cache_paths
  script:
    - pnpm install --no-save
        tslint codelyzer tslint-eslint-rules
    - pnpx ionic-app-scripts lint --bailOnLintError true

build:dev:web:
  <<: *collect_artifacts
  stage: build
  script:
    - change-environment offline
    - build-www
    - mv www www-dev-offline

build:dev:android:
  <<: *collect_artifacts
  stage: build
  variables:
    BUILD_FLAGS: --debug
  script: &android_build
    - npm config set shrinkwrap-only true
    - ionic cordova platform add android
    - npm config set shrinkwrap-only false
    - ionic cordova build android $BUILD_FLAGS
    - ls -al $ANDROID_ARTIFACT_DIR

build:prod:web:
  <<: *collect_artifacts
  stage: build
  script:
    - build-www --prod

build:prod:android:
  <<: *collect_artifacts
  stage: build
  variables:
    BUILD_FLAGS: --prod --release
  script: *android_build

verify:e2e:
  stage: verify
  image: selenium/standalone-chrome:latest
  dependencies:
    - build:dev:web
  cache:
    key: e2e
    paths:
      - node_modules
  before_script:
    - curl -o- https://raw.githubusercontent.com/creationix/nvm/v0.33.11/install.sh | bash
    - . "$HOME/.nvm/nvm.sh"  # This loads nvm
    - nvm install 8
    - npm install http-server jasmine-spec-reporter minimist protractor
                     ts-node '@types/jasmine'
    - export PATH=$CI_PROJECT_DIR/.ci/bin:$PATH
    - npm run e2e-update
  script: test-e2e www-dev-offline
